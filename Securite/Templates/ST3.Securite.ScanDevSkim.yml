# Template pour le scan DevSkim
# DevSkim est un outil de d√©tection de patterns de s√©curit√© dans le code source
# Il identifie les pratiques de codage non s√©curis√©es et les vuln√©rabilit√©s courantes
# 
# Contact: Fabiano Liberati, Martin Desmeules
# Date: 2025-11-30

parameters:
  # R√©pertoire source √† scanner
  - name: sourcesDirectory
    type: string
    default: '$(Build.SourcesDirectory)'
  
  # Continuer en cas d'erreur
  - name: continueOnError
    type: boolean
    default: false
  
  # Publier les r√©sultats dans Advanced Security
  - name: publishToAdvancedSecurity
    type: boolean
    default: true

steps:
  # ========================================
  # Installation de DevSkim CLI
  # ========================================
  - task: PowerShell@2
    displayName: 'DevSkim - Installation'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "Installation de DevSkim CLI..."
        dotnet tool install --global Microsoft.CST.DevSkim.CLI --version 1.0.* 2>&1 | Out-Null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "‚úÖ DevSkim install√© avec succ√®s"
        } else {
          Write-Host "‚ö†Ô∏è DevSkim d√©j√† install√© ou erreur d'installation, on continue..."
        }
        
        # V√©rifier l'installation
        $devskimPath = (Get-Command devskim -ErrorAction SilentlyContinue).Source
        if ($devskimPath) {
          Write-Host "‚úÖ DevSkim trouv√© : $devskimPath"
          devskim --version
        } else {
          Write-Error "‚ùå DevSkim n'est pas accessible dans le PATH"
          exit 1
        }
    continueOnError: false

  # ========================================
  # Ex√©cution du scan DevSkim
  # ========================================
  - task: PowerShell@2
    displayName: 'DevSkim - Analyse du code'
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "D√©marrage de l'analyse DevSkim..."
        Write-Host "R√©pertoire source: ${{ parameters.sourcesDirectory }}"
        
        # Cr√©er le r√©pertoire de sortie pour les r√©sultats
        $outputDir = Join-Path "$(Build.ArtifactStagingDirectory)" "DevSkim"
        New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
        
        $sarifFile = Join-Path $outputDir "devskim-results.sarif"
        
        # Ex√©cuter DevSkim avec sortie SARIF
        devskim analyze "${{ parameters.sourcesDirectory }}" `
          --output-file "$sarifFile" `
          --output-format sarif `
          --severity-level Critical,Important,Moderate `
          --crawl-archives false
        
        $exitCode = $LASTEXITCODE
        
        if (Test-Path $sarifFile) {
          $fileSize = (Get-Item $sarifFile).Length
          Write-Host "‚úÖ Fichier SARIF g√©n√©r√© : $sarifFile ($fileSize octets)"
          
          # Afficher un r√©sum√© des r√©sultats
          $sarif = Get-Content $sarifFile -Raw | ConvertFrom-Json
          $runCount = $sarif.runs.Count
          if ($runCount -gt 0) {
            $resultCount = $sarif.runs[0].results.Count
            Write-Host "üìä Nombre de probl√®mes d√©tect√©s : $resultCount"
          }
        } else {
          Write-Warning "‚ö†Ô∏è Aucun fichier SARIF g√©n√©r√©"
        }
        
        # Ne pas √©chouer si des vuln√©rabilit√©s sont trouv√©es
        if ($exitCode -ne 0) {
          Write-Host "‚ö†Ô∏è DevSkim a d√©tect√© des probl√®mes (exit code: $exitCode)"
        }
        
        exit 0
    continueOnError: ${{ parameters.continueOnError }}

  # ========================================
  # Publication des r√©sultats SARIF
  # ========================================
  - task: PublishBuildArtifacts@1
    displayName: 'DevSkim - Publication des artefacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)/DevSkim'
      ArtifactName: 'DevSkim-SecurityResults'
      publishLocation: 'Container'
    condition: always()

  # ========================================
  # Upload vers Advanced Security (si activ√©)
  # ========================================
  - ${{ if eq(parameters.publishToAdvancedSecurity, true) }}:
    - task: PowerShell@2
      displayName: 'DevSkim - Upload vers Advanced Security'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "Upload des r√©sultats DevSkim vers Advanced Security..."
          $sarifFile = "$(Build.ArtifactStagingDirectory)/DevSkim/devskim-results.sarif"
          
          if (Test-Path $sarifFile) {
            Write-Host "‚úÖ Fichier SARIF trouv√©, upload en cours..."
            # Note: Cette t√¢che n√©cessite l'extension Advanced Security
            # Les r√©sultats SARIF seront automatiquement d√©tect√©s et int√©gr√©s
          } else {
            Write-Warning "‚ö†Ô∏è Aucun fichier SARIF √† uploader"
          }
      continueOnError: true
